---
interface TagCount {
    tag: string;
    count: number;
}

interface Props {
    /** Array of tag objects with name and count */
    tags: TagCount[];
    /** Total number of items (for "All" button) */
    totalCount: number;
    /** CSS selector for cards to filter (e.g., ".post-card" or ".note-card") */
    cardSelector: string;
    /** Maximum number of tags to display (default: 10) */
    maxTags?: number;
}

const { tags, totalCount, cardSelector, maxTags = 10 } = Astro.props;
---

{
    tags.length > 0 && (
        <div
            class="tag-filter-container flex flex-wrap gap-2 mb-10 animate-fade-up stagger-1"
            data-card-selector={cardSelector}
        >
            <button
                class="tag-filter active px-3 py-1.5 rounded-full text-sm transition-all"
                data-tag="all"
            >
                All ({totalCount})
            </button>
            {tags.slice(0, maxTags).map((item) => (
                <button
                    class="tag-filter px-3 py-1.5 rounded-full text-sm transition-all"
                    data-tag={item.tag}
                >
                    {item.tag} ({item.count})
                </button>
            ))}
        </div>
    )
}

<style is:global>
    .tag-filter {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--fallback-bc, #f8f4fc);
        opacity: 0.7;
    }

    .tag-filter:hover,
    .tag-filter.active {
        background: rgba(244, 114, 182, 0.15);
        border-color: rgba(244, 114, 182, 0.3);
        color: var(--color-accent-500, #ec4899);
        opacity: 1;
    }

    [data-theme="light"] .tag-filter {
        background: rgba(0, 0, 0, 0.03);
        border-color: rgba(0, 0, 0, 0.1);
        color: #1a1225;
    }

    [data-theme="light"] .tag-filter:hover,
    [data-theme="light"] .tag-filter.active {
        background: rgba(236, 72, 153, 0.1);
        border-color: rgba(236, 72, 153, 0.3);
        color: var(--color-accent-600, #db2777);
        opacity: 1;
    }
</style>

<script>
    function initTagFilters() {
        const containers = document.querySelectorAll(".tag-filter-container");

        containers.forEach((container) => {
            const cardSelector = container.getAttribute("data-card-selector");
            if (!cardSelector) return;

            const tagFilters = container.querySelectorAll(".tag-filter");
            const cards = document.querySelectorAll(cardSelector);

            if (!tagFilters.length || !cards.length) return;

            tagFilters.forEach((btn) => {
                // Clone to remove old listeners
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);

                newBtn.addEventListener("click", () => {
                    // Update active state
                    container
                        .querySelectorAll(".tag-filter")
                        .forEach((b) => b.classList.remove("active"));
                    newBtn.classList.add("active");

                    const selectedTag = newBtn.getAttribute("data-tag");

                    cards.forEach((card) => {
                        const itemTags = JSON.parse(
                            card.getAttribute("data-tags") || "[]",
                        );

                        if (
                            selectedTag === "all" ||
                            itemTags.includes(selectedTag)
                        ) {
                            card.classList.remove("hidden");
                        } else {
                            card.classList.add("hidden");
                        }
                    });
                });
            });
        });
    }

    // Init on first load and on view transitions
    initTagFilters();
    document.addEventListener("astro:page-load", initTagFilters);
</script>
