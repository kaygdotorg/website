---
/**
 * =============================================================================
 * CONTENT CARD COMPONENT
 * =============================================================================
 *
 * A reusable card component for displaying content entries in list views.
 * Used by blog.astro and notes.astro for consistent card rendering.
 *
 * FEATURES:
 * - Cover image with hover scale effect
 * - Title, description, and date display
 * - Optional tags with # prefix
 * - Optional section label (e.g., "Digital Garden" for notes)
 * - Hover arrow indicator on desktop
 * - Staggered animation support via index prop
 *
 * USAGE:
 * ```astro
 * <ContentCard
 *   entry={post}
 *   basePath="/blog"
 *   index={0}
 *   showTags={true}
 *   cardClass="post-card"
 * />
 * ```
 *
 * ASTRO 5 COMPATIBILITY:
 * - Uses entry.id for URL construction (works with glob loader's generateId)
 * - Uses entry.body for excerpt extraction (still available with glob loader)
 */
import Icon from "./Icon.astro";
import { formatDate } from "../utils/dates";
import { getExcerpt } from "../utils/markdown";
import { getUrlSlug } from "../utils/content";

// =============================================================================
// PROPS INTERFACE
// =============================================================================

interface Props {
  /** The content entry to display */
  entry: any;

  /** Base URL path for links (e.g., "/blog", "/notes") */
  basePath: string;

  /** Index for staggered animation delay (capped at 0.5s max delay) */
  index: number;

  /** CSS class for the card element (used by TagFilter for show/hide) */
  cardClass?: string;

  /** Whether to show tags on the card (default: true) */
  showTags?: boolean;

  /** Optional label to display above the title (e.g., "Digital Garden") */
  sectionLabel?: string;
}

// =============================================================================
// DATA EXTRACTION
// =============================================================================

const {
  entry,
  basePath,
  index,
  cardClass = "content-card",
  showTags = true,
  sectionLabel,
} = Astro.props;

/**
 * Extract cover image from frontmatter.
 * Can be a string URL or an ImageMetadata object from Astro's image optimizer.
 */
const coverImage = entry.data["cover-image"];

/**
 * Get description from frontmatter, or extract from content body.
 * Falls back to undefined if neither is available.
 */
const description = entry.data.description || getExcerpt(entry.body);

/**
 * Get tags array, defaulting to empty array if not present.
 */
const tags = entry.data.tags || [];

/**
 * Build the full URL for this entry.
 * Uses getUrlSlug which prefers frontmatter slug over entry.id.
 */
const href = `${basePath}/${getUrlSlug(entry)}`;
---

<article
  class={`${cardClass} frosted-card p-6 rounded-2xl glow-hover transition-all animate-fade-up`}
  data-tags={JSON.stringify(tags)}
  style={`animation-delay: ${Math.min(index * 0.05, 0.5)}s`}
>
  <a href={href} class="block group">
    <div class="flex flex-col md:flex-row md:items-start gap-4">
      {/* =======================================================================
          COVER IMAGE (optional)
          Displayed on the left side on desktop, full width on mobile.
          ======================================================================= */}
      {coverImage && (
        <div class="w-full md:w-32 h-24 md:h-20 rounded-lg overflow-hidden flex-shrink-0">
          <img
            src={typeof coverImage === "string" ? coverImage : coverImage.src}
            alt={entry.data.title}
            class="w-full h-full object-cover transition-transform group-hover:scale-105"
            loading="lazy"
            decoding="async"
          />
        </div>
      )}

      {/* =======================================================================
          CONTENT SECTION
          Contains section label, title, description, and metadata.
          ======================================================================= */}
      <div class="flex-1 min-w-0">
        {/* Section label (e.g., "Digital Garden") */}
        {sectionLabel && (
          <span class="text-accent font-medium tracking-widest uppercase text-xs mb-2 block">
            {sectionLabel}
          </span>
        )}

        {/* Entry title */}
        <h2 class="font-display text-xl font-medium mb-2 group-hover:text-accent transition-colors">
          {entry.data.title}
        </h2>

        {/* Description/excerpt (truncated to 2 lines) */}
        {description && (
          <p class="text-base-content/60 text-sm mb-3 line-clamp-2">
            {description}
          </p>
        )}

        {/* Metadata row: date and tags */}
        <div class="flex flex-wrap items-center gap-3 text-xs text-base-content/50">
          {/* Publication date */}
          <time datetime={entry.data.date.toISOString()}>
            {formatDate(entry.data.date)}
          </time>

          {/* Tags (if enabled and present) */}
          {showTags && tags.length > 0 && (
            <>
              <span class="opacity-30">â€¢</span>
              <div class="flex gap-2">
                {tags.slice(0, 3).map((tag: string) => (
                  <span class="text-accent/70">#{tag}</span>
                ))}
              </div>
            </>
          )}
        </div>
      </div>

      {/* =======================================================================
          HOVER ARROW
          Shows on desktop when hovering the card.
          ======================================================================= */}
      <div class="hidden md:flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
        <Icon name="arrow" class="w-4 h-4 text-accent" />
      </div>
    </div>
  </a>
</article>

<style>
  /* Truncate description to 2 lines with ellipsis */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
