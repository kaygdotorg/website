---
import MarkdownLayout from "../../layouts/MarkdownLayout.astro";
import { getCollection } from "astro:content";

// Helper to get the URL slug (frontmatter slug or filename)
function getUrlSlug(talk: any): string {
    return talk.data.slug || talk.slug;
}

export async function getStaticPaths() {
    const talks = await getCollection("talks");
    return talks.map((talk) => ({
        // Use frontmatter slug for URL, fallback to file slug
        params: { slug: talk.data.slug || talk.slug },
        props: { talk },
    }));
}

const { talk } = Astro.props;
const { Content } = await talk.render();

// Calculate reading time
const wordCount = talk.body?.split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Get dates
const createdDate = talk.data.date;
const lastEdited = talk.data["last edited"];

// Get all talks for prev/next navigation
const allTalks = await getCollection("talks", ({ data }) => !data.draft);
const sortedTalks = allTalks.sort(
    (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

const currentIndex = sortedTalks.findIndex(
    (t) => getUrlSlug(t) === getUrlSlug(talk),
);
const prevTalk =
    currentIndex < sortedTalks.length - 1
        ? sortedTalks[currentIndex + 1]
        : null;
const nextTalk = currentIndex > 0 ? sortedTalks[currentIndex - 1] : null;

// Create backlinks
const backlinks = [{ title: "← All Talks", href: "/talks" }];
if (prevTalk) {
    backlinks.push({
        title: `← ${prevTalk.data.title}`,
        href: `/talks/${getUrlSlug(prevTalk)}`,
    });
}
if (nextTalk) {
    backlinks.push({
        title: `${nextTalk.data.title} →`,
        href: `/talks/${getUrlSlug(nextTalk)}`,
    });
}
---

<MarkdownLayout
    title={talk.data.title}
    description={talk.data.description}
    createdDate={createdDate}
    lastEdited={lastEdited}
    readingTime={readingTime}
    backlinks={backlinks}
    coverImage={talk.data["cover-image"]}
>
    {
        talk.data.tags && talk.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-6">
                {talk.data.tags.map((tag: string) => (
                    <span class="px-3 py-1 text-xs rounded-full bg-white/10 text-white/80">
                        {tag}
                    </span>
                ))}
            </div>
        )
    }

    <Content />
</MarkdownLayout>
