---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { formatDate, getRelativeTime } from "../utils/dates";

// Get all writing posts, exclude drafts, sort by date
const allPosts = await getCollection("writing", ({ data }) => !data.draft);
const posts = allPosts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

// Get unique tags
const allTags = [
  ...new Set(posts.flatMap((post) => post.data.tags || [])),
].sort();
---

<BaseLayout
  title="Writing"
  description="Thoughts on technology, creativity, and life"
>
  <section class="max-w-4xl mx-auto px-4 md:px-6 py-12 md:py-24">
    <!-- Header -->
    <header class="mb-12 max-w-2xl animate-fade-up">
      <h1 class="font-display text-4xl md:text-5xl mb-4 gradient-text">
        Writing
      </h1>
      <p class="text-base-content/70 text-lg leading-relaxed">
        {posts.length} posts on technology, homelab, film, and everything in between.
      </p>
    </header>

    <!-- Tag Filters -->
    {
      allTags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-10 animate-fade-up stagger-1">
          <button
            class="tag-filter active px-3 py-1.5 rounded-full text-sm transition-all"
            data-tag="all"
          >
            All ({posts.length})
          </button>
          {allTags.slice(0, 10).map((tag) => {
            const count = posts.filter((p) =>
              p.data.tags?.includes(tag),
            ).length;
            return (
              <button
                class="tag-filter px-3 py-1.5 rounded-full text-sm transition-all"
                data-tag={tag}
              >
                {tag} ({count})
              </button>
            );
          })}
        </div>
      )
    }

    <!-- Posts List -->
    <div class="space-y-6">
      {
        posts.map((post, index) => (
          <article
            class="post-card grainy-card p-6 rounded-2xl glow-hover transition-all animate-fade-up"
            data-tags={JSON.stringify(post.data.tags || [])}
            style={`animation-delay: ${Math.min(index * 0.05, 0.5)}s`}
          >
            <a
              href={`/writing/${post.data.slug || post.slug}`}
              class="block group"
            >
              <div class="flex flex-col md:flex-row md:items-start gap-4">
                {/* Feature Image */}
                {post.data.image && (
                  <div class="w-full md:w-32 h-24 md:h-20 rounded-lg overflow-hidden flex-shrink-0">
                    <img
                      src={post.data.image}
                      alt={post.data.title}
                      class="w-full h-full object-cover transition-transform group-hover:scale-105"
                      loading="lazy"
                    />
                  </div>
                )}

                {/* Content */}
                <div class="flex-1 min-w-0">
                  <h2 class="font-display text-xl font-medium mb-2 group-hover:text-accent transition-colors">
                    {post.data.title}
                  </h2>

                  {post.data.description && (
                    <p class="text-base-content/60 text-sm mb-3 line-clamp-2">
                      {post.data.description}
                    </p>
                  )}

                  <div class="flex flex-wrap items-center gap-3 text-xs text-base-content/50">
                    <time datetime={post.data.date.toISOString()}>
                      {formatDate(post.data.date)}
                    </time>

                    {post.data.tags && post.data.tags.length > 0 && (
                      <>
                        <span>Â·</span>
                        <div class="flex flex-wrap gap-1">
                          {post.data.tags.slice(0, 3).map((tag) => (
                            <span class="px-2 py-0.5 rounded-full bg-base-content/5">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                </div>

                {/* Arrow */}
                <div class="hidden md:flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                  <svg
                    class="w-5 h-5 text-accent"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 8l4 4m0 0l-4 4m4-4H3"
                    />
                  </svg>
                </div>
              </div>
            </a>
          </article>
        ))
      }
    </div>
  </section>

  <style>
    .tag-filter {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--fallback-bc, #f8f4fc);
      opacity: 0.7;
    }

    .tag-filter:hover,
    .tag-filter.active {
      background: rgba(244, 114, 182, 0.15);
      border-color: rgba(244, 114, 182, 0.3);
      color: var(--color-accent-500, #ec4899);
      opacity: 1;
    }

    [data-theme="light"] .tag-filter {
      background: rgba(0, 0, 0, 0.03);
      border-color: rgba(0, 0, 0, 0.1);
      color: #1a1225;
    }

    [data-theme="light"] .tag-filter:hover,
    [data-theme="light"] .tag-filter.active {
      background: rgba(236, 72, 153, 0.1);
      border-color: rgba(236, 72, 153, 0.3);
      color: var(--color-accent-600, #db2777);
    }

    .post-card.hidden {
      display: none;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>

  <script>
    const tagFilters = document.querySelectorAll(".tag-filter");
    const postCards = document.querySelectorAll(".post-card");

    tagFilters.forEach((btn) => {
      btn.addEventListener("click", () => {
        // Update active state
        tagFilters.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const selectedTag = btn.getAttribute("data-tag");

        postCards.forEach((card) => {
          const postTags = JSON.parse(card.getAttribute("data-tags") || "[]");

          if (selectedTag === "all" || postTags.includes(selectedTag)) {
            card.classList.remove("hidden");
          } else {
            card.classList.add("hidden");
          }
        });
      });
    });
  </script>
</BaseLayout>
