---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getEntry, getCollection } from "astro:content";
import { formatDateWithComma } from "../utils/dates";

// Load content from home.md
const homeEntry = await getEntry("pages", "home");

if (!homeEntry) {
  throw new Error("Could not find home.md in src/content/pages/");
}

const { Content } = await homeEntry.render();

// Fetch entries from now and uses collections to get latest dates
const nowEntries = await getCollection("now");
const usesEntries = await getCollection("uses");

// Sort to get latest entries (dates are now always Date objects thanks to z.coerce.date())
const latestNow = nowEntries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
)[0];
const latestUses = usesEntries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
)[0];

// Create a map of slug -> lastUpdated date
const pageLastUpdated = new Map<string, Date>();
if (latestNow) {
  pageLastUpdated.set("/now", latestNow.data.date);
}
if (latestUses) {
  pageLastUpdated.set("/uses", latestUses.data.date);
}

// Extract all the data from frontmatter
const {
  name,
  tagline,
  profileImage,
  email,
  cardPhotos: rawCardPhotos,
  pageCards,
  quote,
} = homeEntry.data;

// Enhance cardPhotos with dynamic dates from page metadata
const cardPhotos = rawCardPhotos?.map((card) => {
  const pageDate = pageLastUpdated.get(card.href);
  return {
    ...card,
    date: pageDate ? formatDateWithComma(pageDate) : card.date || "Unknown",
  };
});
---

<BaseLayout
  title="Home"
  description="Personal website and digital garden"
  hideNavInitially={true}
>
  <main class="homepage">
    <!-- Hero Section -->
    <section class="hero-section" id="hero-section">
      <div class="grainy-card-homepage hero-card">
        <div class="hero-content">
          <!-- Profile Picture -->
          {
            profileImage && (
              <div class="hero-profile">
                <img
                  src={profileImage}
                  alt={`${name || "Profile"} photo`}
                  class="hero-profile-img"
                  fetchpriority="high"
                />
              </div>
            )
          }

          <!-- Name -->
          <h1 class="hero-name">
            <span class="text-accent">{name}</span>
          </h1>

          <!-- Tagline -->
          <p class="hero-tagline">
            {tagline}
          </p>
        </div>

        <!-- Card Hand (Polaroids) -->
        {
          cardPhotos && cardPhotos.length > 0 && (
            <div class="hero-cards-section" id="hero-photo-section">
              <div class="card-hand" id="card-hand">
                <div class="card-hand-inner" id="card-hand-inner">
                  {cardPhotos.map((item, index) => (
                    <a
                      href={item.href}
                      class="card-in-hand"
                      data-index={index}
                      data-position={index}
                    >
                      <div class="card-in-hand-image">
                        <img
                          src={item.src}
                          alt={item.label}
                          draggable="false"
                          loading="lazy"
                        />
                      </div>
                      <div class="card-in-hand-label">
                        <div class="card-in-hand-slug">{item.href}</div>
                        <div class="card-in-hand-date">
                          {item.date || "Dec 2024"}
                        </div>
                      </div>
                    </a>
                  ))}
                </div>
              </div>
              <p class="hero-cards-hint">
                swipe to shuffle · tap to navigate · scroll to explore
              </p>
            </div>
          )
        }
      </div>
    </section>

    <!-- Bento Grid Section (placeholder for future implementation) -->
    <section class="bento-section">
      <p class="bento-placeholder">Bento grid coming soon...</p>
    </section>
  </main>

  <!-- Card Hand Swipe Script -->
  <script>
    const cardHand = document.getElementById("card-hand");
    const cards = document.querySelectorAll(
      ".card-in-hand",
    ) as NodeListOf<HTMLElement>;

    if (cardHand && cards.length > 0) {
      const numCards = cards.length;
      let currentOffset = 0;
      let isDragging = false;
      let hasMoved = false;
      let startX = 0;
      let currentX = 0;
      let dragThreshold = 50;
      let tapThreshold = 10;

      function updateCardPositions() {
        cards.forEach((card, index) => {
          let posIndex = (index - currentOffset + numCards) % numCards;
          card.setAttribute("data-position", posIndex.toString());
        });
      }

      function handleCardStart(e: MouseEvent | TouchEvent) {
        isDragging = true;
        hasMoved = false;
        startX = "touches" in e ? e.touches[0].clientX : e.clientX;
        currentX = startX;
        e.stopPropagation();
      }

      function handleCardMove(e: MouseEvent | TouchEvent) {
        if (!isDragging) return;
        currentX = "touches" in e ? e.touches[0].clientX : e.clientX;

        if (Math.abs(currentX - startX) > tapThreshold) {
          hasMoved = true;
        }
      }

      function handleCardEnd() {
        if (!isDragging) return;
        isDragging = false;

        const deltaX = currentX - startX;

        if (Math.abs(deltaX) > dragThreshold) {
          if (deltaX < 0) {
            currentOffset = (currentOffset + 1) % numCards;
          } else {
            currentOffset = (currentOffset - 1 + numCards) % numCards;
          }
          updateCardPositions();
        }
      }

      cards.forEach((card) => {
        card.addEventListener("click", (e) => {
          if (hasMoved) {
            e.preventDefault();
            e.stopPropagation();
          }
          hasMoved = false;
        });

        card.addEventListener("mousedown", handleCardStart);
        card.addEventListener("touchstart", handleCardStart, {
          passive: false,
        });
      });

      cardHand.addEventListener("mousedown", handleCardStart);
      cardHand.addEventListener("touchstart", handleCardStart, {
        passive: false,
      });

      document.addEventListener("mousemove", handleCardMove);
      document.addEventListener("mouseup", handleCardEnd);
      document.addEventListener("touchmove", handleCardMove, { passive: true });
      document.addEventListener("touchend", handleCardEnd);

      // Horizontal scroll/wheel to shuffle cards
      let wheelTimeout: ReturnType<typeof setTimeout> | null = null;
      let accumulatedDelta = 0;
      const wheelThreshold = 50;

      cardHand.addEventListener(
        "wheel",
        (e: WheelEvent) => {
          const delta =
            Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;

          e.stopPropagation();
          accumulatedDelta += delta;

          if (wheelTimeout) clearTimeout(wheelTimeout);

          if (Math.abs(accumulatedDelta) > wheelThreshold) {
            if (accumulatedDelta > 0) {
              currentOffset = (currentOffset + 1) % numCards;
            } else {
              currentOffset = (currentOffset - 1 + numCards) % numCards;
            }
            updateCardPositions();
            accumulatedDelta = 0;
          }

          wheelTimeout = setTimeout(() => {
            accumulatedDelta = 0;
          }, 150);
        },
        { passive: true },
      );

      updateCardPositions();
    }

    // Scroll-Aware Navigation Logic
    document.addEventListener("astro:page-load", () => {
      const heroSection = document.getElementById("hero-section");
      const navContainer = document.getElementById("nav-container");
      const blurOverlay = document.getElementById("navbar-blur");

      if (heroSection && navContainer) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (!entry.isIntersecting) {
                // Hero is out of view (scrolled past) -> Show Nav & Blur
                navContainer.classList.remove("nav-hidden");
                navContainer.classList.add("nav-visible");
                blurOverlay?.classList.remove("blur-hidden");
              } else {
                // Hero is in view -> Hide Nav & Blur
                navContainer.classList.remove("nav-visible");
                navContainer.classList.add("nav-hidden");
                blurOverlay?.classList.add("blur-hidden");
              }
            });
          },
          {
            root: null,
            threshold: 0,
            rootMargin: "-100px 0px 0px 0px", // Trigger slightly before hero completely leaves
          },
        );

        observer.observe(heroSection);

        // Cleanup
        document.addEventListener(
          "astro:before-swap",
          () => {
            observer.disconnect();
          },
          { once: true },
        );
      }
    });
  </script>

  <style>
    /* Homepage Layout */
    .homepage {
      display: flex;
      flex-direction: column;
      gap: 4rem;
      padding: 0; /* Remove padding to allow hero to fill screen */
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Hero Section - Full viewport, centered */
    .hero-section {
      min-height: 100vh;
      min-height: 100dvh; /* Dynamic viewport height for mobile */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .hero-card {
      padding: 3rem;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }

    .hero-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .hero-profile {
      width: 8rem;
      height: 8rem;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--color-pink-400, #f472b6);
    }

    .hero-profile-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .hero-name {
      font-family: var(--font-heading, "Playfair Display", Georgia, serif);
      font-size: 3rem;
      font-weight: 400;
      line-height: 1.1;
      letter-spacing: -0.07em;
    }

    @media (min-width: 768px) {
      .hero-name {
        font-size: 4rem;
      }
    }

    .hero-tagline {
      font-size: 1.125rem;
      color: var(--color-base-content, inherit);
      opacity: 0.8;
      max-width: 400px;
      line-height: 1.6;
    }

    .hero-cards-section {
      margin-top: 1rem;
    }

    .hero-cards-hint {
      text-align: center;
      font-size: 0.875rem;
      color: var(--color-base-content, inherit);
      opacity: 0.6;
      margin-top: 1rem;
    }

    /* Bento Section Placeholder */
    .bento-section {
      padding: 4rem 0;
    }

    .bento-placeholder {
      text-align: center;
      font-size: 1.25rem;
      color: var(--color-base-content, inherit);
      opacity: 0.5;
      padding: 4rem;
      border: 2px dashed var(--color-base-content, inherit);
      opacity: 0.2;
      border-radius: 1.5rem;
    }

    /* Footer Section */
    .footer-section {
      padding: 4rem 0 8rem;
      display: flex;
      justify-content: center;
    }

    .footer-card {
      padding: 3rem;
      max-width: 600px;
      text-align: center;
    }

    .footer-quote {
      font-family: var(--font-heading, "Playfair Display", Georgia, serif);
      font-size: 1.5rem;
      font-style: italic;
      color: var(--color-base-content, inherit);
      opacity: 0.8;
      line-height: 1.4;
      letter-spacing: -0.02em;
    }

    .footer-cta {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 2rem;
      color: var(--color-accent, #ec4899);
      font-size: 1rem;
      text-decoration: none;
      transition: gap 0.3s ease;
    }

    .footer-cta:hover {
      gap: 1rem;
    }

    .footer-cta svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .homepage {
        padding: 1rem;
        gap: 3rem;
      }

      .hero-section {
        flex: 1;
      }

      .hero-card {
        padding: 2rem;
      }

      .hero-name {
        font-size: 2.75rem;
      }

      .hero-profile {
        width: 6rem;
        height: 6rem;
      }
    }
  </style>
</BaseLayout>
