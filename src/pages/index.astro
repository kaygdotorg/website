---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getEntry, getCollection } from "astro:content";
import { formatDateWithComma } from "../utils/dates";

// Load content from home.md
const homeEntry = await getEntry("pages", "home");

if (!homeEntry) {
  throw new Error("Could not find home.md in src/content/pages/");
}

// Extract all the data from frontmatter
const {
  name,
  tagline,
  profileImage,
  email,
  cardPhotos,
  quote,
  socialLinks,
  interests,
} = homeEntry.data;

// Fetch latest writing post
const writingPosts = await getCollection("writing");
const latestPost = writingPosts
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())[0];

// Fetch latest now entry
const nowEntries = await getCollection("now");
const latestNow = nowEntries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
)[0];

// Fetch uses entries
const usesEntries = await getCollection("uses");
const latestUses = usesEntries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
)[0];

// Get post count
const postCount = writingPosts.filter((p) => !p.data.draft).length;
---

<BaseLayout
  title="Home"
  description="Personal website and digital garden"
  hideNavInitially={false}
>
  <div class="bento-container">
    <!-- Bento Grid -->
    <div class="bento-grid">
      <!-- Hero Card: Profile + Name (spans 2x2) -->
      <a
        href="/about"
        class="bento-cell bento-wide grainy-card bento-hero-content"
      >
        <div class="bento-content">
          <div class="hero-profile">
            {
              profileImage && (
                <div class="hero-avatar">
                  <img
                    src={profileImage}
                    alt={`${name || "Profile"} photo`}
                    fetchpriority="high"
                  />
                </div>
              )
            }
            <div class="hero-info">
              <h1 class="bento-title gradient-text">{name}</h1>
              <p class="bento-subtitle">{tagline}</p>
            </div>
          </div>
          <div class="bento-arrow">
            <span>about me</span>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </div>
        </div>
      </a>

      <!-- Latest Writing Card (spans 2 columns) -->
      {
        latestPost && (
          <a
            href={`/writing/${latestPost.data.slug || latestPost.slug}`}
            class="bento-cell bento-wide bento-image"
            style={`background-image: url('${latestPost.data.image || "https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=800&q=80"}');`}
          >
            <div class="bento-content">
              <div>
                <span class="bento-tag">Latest Writing</span>
                <h2 class="bento-title">{latestPost.data.title}</h2>
                <p class="bento-subtitle bento-excerpt">
                  {latestPost.data.description?.slice(0, 120)}...
                </p>
              </div>
              <div class="bento-arrow">
                <span>read more</span>
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 8l4 4m0 0l-4 4m4-4H3"
                  />
                </svg>
              </div>
            </div>
          </a>
        )
      }

      <!-- Now Card -->
      <a href="/now" class="bento-cell grainy-card bento-now">
        <div class="bento-content">
          <div>
            <span class="bento-tag">Now</span>
            <h2 class="bento-title">What I'm up to</h2>
            <p class="bento-subtitle">
              {
                latestNow
                  ? `Updated ${formatDateWithComma(latestNow.data.date)}`
                  : "Current focus and activities"
              }
            </p>
          </div>
          <div class="now-pulse"></div>
          <div class="bento-arrow">
            <span>see more</span>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </div>
        </div>
      </a>

      <!-- Photography Card -->
      <a
        href="/photography"
        class="bento-cell bento-image bento-tall"
        style="background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=600&q=80');"
      >
        <div class="bento-content">
          <div>
            <span class="bento-tag">Photography</span>
            <h2 class="bento-title">Captured moments</h2>
          </div>
          <div class="bento-arrow">
            <span>view gallery</span>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </div>
        </div>
      </a>

      <!-- Uses Card -->
      <a href="/uses" class="bento-cell grainy-card">
        <div class="bento-content">
          <div>
            <span class="bento-tag">Uses</span>
            <h2 class="bento-title">My tools</h2>
            <p class="bento-subtitle">
              Software, hardware, and gear I use daily
            </p>
          </div>
          <div class="bento-arrow">
            <span>explore</span>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </div>
        </div>
      </a>

      <!-- Writing Archive Card -->
      <a href="/writing" class="bento-cell grainy-card">
        <div class="bento-content">
          <div>
            <span class="bento-tag">Writing</span>
            <h2 class="bento-title">
              {postCount}
              {postCount === 1 ? "post" : "posts"}
            </h2>
            <p class="bento-subtitle">Thoughts on technology and life</p>
          </div>
          <div class="bento-arrow">
            <span>browse all</span>
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </div>
        </div>
      </a>

      <!-- Contact Card (spans 2 columns) -->
      <a
        href={`mailto:${email}`}
        class="bento-cell bento-wide grainy-card bento-contact"
      >
        <div class="bento-content">
          <div>
            <span class="bento-tag">Contact</span>
            <h2 class="bento-title">Let's connect</h2>
            <p class="bento-subtitle bento-quote">"{quote}"</p>
          </div>
          <div class="contact-actions">
            <span class="contact-email">{email}</span>
            <div class="bento-arrow">
              <span>get in touch</span>
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
              </svg>
            </div>
          </div>
        </div>
      </a>
    </div>
  </div>

  <style>
    .bento-container {
      min-height: 100vh;
      padding-top: 2rem;
    }

    /* Hero card specific styles */
    .hero-profile {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      .hero-profile {
        flex-direction: row;
        align-items: center;
      }
    }

    .hero-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--color-accent-500, #ec4899);
      flex-shrink: 0;
    }

    @media (min-width: 768px) {
      .hero-avatar {
        width: 120px;
        height: 120px;
      }
    }

    .hero-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .hero-info {
      flex: 1;
    }

    /* Gradient text for name */
    .gradient-text {
      background: linear-gradient(
        135deg,
        #f472b6 0%,
        #a855f7 50%,
        #ec4899 100%
      );
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Tag label */
    .bento-tag {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-accent-500, #ec4899);
      margin-bottom: 0.5rem;
      opacity: 0.9;
    }

    /* Excerpt styling */
    .bento-excerpt {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Quote styling */
    .bento-quote {
      font-style: italic;
      opacity: 0.8;
    }

    /* Now card pulse animation */
    .bento-now {
      position: relative;
    }

    .now-pulse {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      width: 12px;
      height: 12px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }

    /* Contact card */
    .bento-contact .bento-content {
      justify-content: space-between;
    }

    .contact-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .contact-email {
      font-family: "Cascadia Code", monospace;
      font-size: 0.875rem;
      opacity: 0.7;
    }

    /* Override arrow visibility for contact */
    .bento-contact .bento-arrow {
      opacity: 1;
      transform: translateX(0);
    }

    /* Ensure grainy cards have proper styling in bento */
    .bento-cell.grainy-card {
      background: rgba(13, 9, 16, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    [data-theme="light"] .bento-cell.grainy-card {
      background: rgba(255, 255, 255, 0.7);
      border-color: rgba(0, 0, 0, 0.06);
    }

    /* Image cards text always white */
    .bento-image .bento-title,
    .bento-image .bento-subtitle,
    .bento-image .bento-tag {
      color: white;
    }

    .bento-image .bento-tag {
      opacity: 0.9;
    }
  </style>
</BaseLayout>
