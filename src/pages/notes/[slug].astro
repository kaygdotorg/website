---
import MarkdownLayout from "../../layouts/MarkdownLayout.astro";
import { getCollection } from "astro:content";

// Helper to get the URL slug (frontmatter slug or filename)
function getUrlSlug(note: any): string {
    return note.data.slug || note.slug;
}

export async function getStaticPaths() {
    const notes = await getCollection("notes");
    return notes.map((note) => ({
        // Use frontmatter slug for URL, fallback to file slug
        params: { slug: note.data.slug || note.slug },
        props: { note },
    }));
}

const { note } = Astro.props;
const { Content } = await note.render();

// Calculate reading time
const wordCount = note.body?.split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Get dates
const createdDate = note.data.date;
const lastEdited = note.data["last edited"];

// Get all notes for prev/next navigation
const allNotes = await getCollection("notes", ({ data }) => !data.draft);
const sortedNotes = allNotes.sort(
    (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

const currentIndex = sortedNotes.findIndex(
    (n) => getUrlSlug(n) === getUrlSlug(note),
);
const prevNote =
    currentIndex < sortedNotes.length - 1
        ? sortedNotes[currentIndex + 1]
        : null;
const nextNote = currentIndex > 0 ? sortedNotes[currentIndex - 1] : null;

// Create backlinks
const backlinks = [{ title: "← All Notes", href: "/notes" }];
if (prevNote) {
    backlinks.push({
        title: `← ${prevNote.data.title}`,
        href: `/notes/${getUrlSlug(prevNote)}`,
    });
}
if (nextNote) {
    backlinks.push({
        title: `${nextNote.data.title} →`,
        href: `/notes/${getUrlSlug(nextNote)}`,
    });
}
---

<MarkdownLayout
    title={note.data.title}
    description={note.data.description}
    createdDate={createdDate}
    lastEdited={lastEdited}
    readingTime={readingTime}
    backlinks={backlinks}
    coverImage={note.data["cover-image"]}
>
    {
        note.data.tags && note.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-6">
                {note.data.tags.map((tag: string) => (
                    <span class="px-3 py-1 text-xs rounded-full bg-white/10 text-white/80">
                        {tag}
                    </span>
                ))}
            </div>
        )
    }

    <Content />
</MarkdownLayout>
