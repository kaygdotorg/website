---
/**
 * Blog List Page
 *
 * Displays all blog posts with tag filtering.
 * Uses ContentCard component for consistent card rendering.
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import ContentCard from "../components/ContentCard.astro";
import TagFilter from "../components/TagFilter.astro";
import { getCollection } from "astro:content";

// Get index.md for page metadata
const allBlogEntries = await getCollection("blog");
const entry = allBlogEntries.find((e) => e.id === "index.md");

if (!entry) {
  throw new Error("Could not find index.md in src/content/blog/");
}

// Get all blog posts, exclude drafts and index.md, sort by date
const posts = allBlogEntries
  .filter((e) => e.id !== "index.md" && !e.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Calculate tag counts for TagFilter
const tagMap = new Map<string, number>();
posts.forEach((post) => {
  (post.data.tags || []).forEach((tag) => {
    tagMap.set(tag, (tagMap.get(tag) || 0) + 1);
  });
});
const tagCounts = Array.from(tagMap, ([tag, count]) => ({ tag, count })).sort(
  (a, b) => b.count - a.count,
);
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <section class="max-w-6xl mx-auto px-4 md:px-6 py-12 md:py-24">
    {/* Header */}
    <header class="mb-12 max-w-2xl animate-fade-up">
      <h1 class="font-display text-4xl md:text-5xl mb-4 gradient-text">
        {entry.data.title}
      </h1>
      <p class="text-base-content/70 text-lg leading-relaxed">
        {entry.data.description}
      </p>
    </header>

    {/* Tag Filter */}
    <TagFilter
      tags={tagCounts}
      totalCount={posts.length}
      cardSelector=".post-card"
    />

    {/* Post List */}
    <div class="space-y-6">
      {
        posts.map((post, index) => (
          <ContentCard
            entry={post}
            basePath="/blog"
            index={index}
            cardClass="post-card"
            showTags={true}
          />
        ))
      }
    </div>
  </section>

  <style>
    .post-card.hidden {
      display: none;
    }
  </style>
</BaseLayout>
