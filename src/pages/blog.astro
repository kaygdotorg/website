---
import BaseLayout from "../layouts/BaseLayout.astro";
import Icon from "../components/Icon.astro";
import TagFilter from "../components/TagFilter.astro";
import { getCollection } from "astro:content";
import { formatDate } from "../utils/dates";

// Get all blog posts, exclude drafts, sort by date
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const posts = allPosts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

// Get unique tags
const allTags = [
  ...new Set(posts.flatMap((post) => post.data.tags || [])),
].sort();
---

<BaseLayout
  title="Writing"
  description="Thoughts on technology, creativity, and life"
>
  <section class="max-w-4xl mx-auto px-4 md:px-6 py-12 md:py-24">
    <!-- Header -->
    <header class="mb-12 max-w-2xl animate-fade-up">
      <h1 class="font-display text-4xl md:text-5xl mb-4 gradient-text">
        Writing
      </h1>
      <p class="text-base-content/70 text-lg leading-relaxed">
        {posts.length} posts on technology, homelab, film, and everything in between.
      </p>
    </header>

    <!-- Tag Filters -->
    <TagFilter
      tags={allTags.slice(0, 10).map((tag) => ({
        tag,
        count: posts.filter((p) => p.data.tags?.includes(tag)).length,
      }))}
      totalCount={posts.length}
      cardSelector=".post-card"
    />

    <!-- Posts List -->
    <div class="space-y-6">
      {
        posts.map((post, index) => (
          <article
            class="post-card frosted-card p-6 rounded-2xl glow-hover transition-all animate-fade-up"
            data-tags={JSON.stringify(post.data.tags || [])}
            style={`animation-delay: ${Math.min(index * 0.05, 0.5)}s`}
          >
            <a
              href={`/blog/${post.data.slug || post.slug}`}
              class="block group"
            >
              <div class="flex flex-col md:flex-row md:items-start gap-4">
                {/* Feature Image */}
                {post.data["cover-image"] && (
                  <div class="w-full md:w-32 h-24 md:h-20 rounded-lg overflow-hidden flex-shrink-0">
                    <img
                      src={
                        typeof post.data["cover-image"] === "string"
                          ? post.data["cover-image"]
                          : post.data["cover-image"].src
                      }
                      alt={post.data.title}
                      class="w-full h-full object-cover transition-transform group-hover:scale-105"
                      loading="lazy"
                    />
                  </div>
                )}

                {/* Content */}
                <div class="flex-1 min-w-0">
                  <h2 class="font-display text-xl font-medium mb-2 group-hover:text-accent transition-colors">
                    {post.data.title}
                  </h2>

                  {post.data.description && (
                    <p class="text-base-content/60 text-sm mb-3 line-clamp-2">
                      {post.data.description}
                    </p>
                  )}

                  <div class="flex flex-wrap items-center gap-3 text-xs text-base-content/50">
                    <time datetime={post.data.date.toISOString()}>
                      {formatDate(post.data.date)}
                    </time>

                    {post.data.tags && post.data.tags.length > 0 && (
                      <>
                        <span>Â·</span>
                        <div class="flex flex-wrap gap-1">
                          {post.data.tags.slice(0, 3).map((tag) => (
                            <span class="px-2 py-0.5 rounded-full bg-base-content/5">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                </div>

                {/* Arrow */}
                <div class="hidden md:flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                  <Icon
                    name="arrow"
                    class="w-5 h-5 text-accent"
                    strokeWidth={2}
                  />
                </div>
              </div>
            </a>
          </article>
        ))
      }
    </div>
  </section>

  <style>
    .post-card.hidden {
      display: none;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</BaseLayout>
