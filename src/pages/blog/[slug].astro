---
import MarkdownLayout from "../../layouts/MarkdownLayout.astro";
import { getCollection } from "astro:content";
import { extractUrlFromMarkdown } from "../../utils/markdown";

// Helper to get the URL slug (frontmatter slug or filename)
function getUrlSlug(post: any): string {
    return post.data.slug || post.slug;
}

export async function getStaticPaths() {
    const posts = await getCollection("blog");
    return posts.map((post) => ({
        // Use frontmatter slug for URL, fallback to file slug
        params: { slug: post.data.slug || post.slug },
        props: { post },
    }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Calculate reading time
const wordCount = post.body?.split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Get dates
const createdDate = post.data.date;
const lastEdited = post.data["last edited"];

// Get all posts for prev/next navigation
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
    (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

const currentIndex = sortedPosts.findIndex(
    (p) => getUrlSlug(p) === getUrlSlug(post),
);
const prevPost =
    currentIndex < sortedPosts.length - 1
        ? sortedPosts[currentIndex + 1]
        : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

// Create backlinks
const backlinks = [{ title: "← All Writing", href: "/blog" }];
if (prevPost) {
    backlinks.push({
        title: `← ${prevPost.data.title}`,
        href: `/blog/${getUrlSlug(prevPost)}`,
    });
}
if (nextPost) {
    backlinks.push({
        title: `${nextPost.data.title} →`,
        href: `/blog/${getUrlSlug(nextPost)}`,
    });
}
---

<MarkdownLayout
    title={post.data.title}
    description={post.data.description}
    createdDate={createdDate}
    lastEdited={lastEdited}
    readingTime={readingTime}
    backlinks={backlinks}
    image={typeof post.data["cover-image"] === "string"
        ? post.data["cover-image"]
        : post.data["cover-image"]?.src}
>
    {
        post.data.tags && post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-6">
                {post.data.tags.map((tag) => (
                    <span class="px-3 py-1 text-xs rounded-full bg-white/10 text-white/80">
                        {tag}
                    </span>
                ))}
            </div>
        )
    }

    <Content />
</MarkdownLayout>
