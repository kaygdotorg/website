---
/**
 * Photography Gallery Page
 * 
 * Displays photos from the 'photos' content collection. Each photo is a
 * markdown file with metadata in frontmatter and optional description in body.
 * Photos are fetched from content/photos/*.md (excluding index.md).
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Get page metadata from photography/index.md
const allPageEntries = await getCollection("photography");
const entry = allPageEntries.find((e) => e.id === "index.md");

if (!entry) {
  throw new Error("Could not find index.md in src/content/photography/");
}

// Get all photos from the photos collection
const photoEntries = await getCollection("photos");

// Transform entries into the format needed for display
const photos = photoEntries.map((photo) => ({
  src: photo.data.src,
  thumb: photo.data.thumb || photo.data.src, // Fallback to src if no thumb
  alt: photo.data.alt,
  title: photo.data.title || photo.data.alt,
  category: photo.data.category,
  location: photo.data.location,
  date: photo.data.date,
  camera: photo.data.camera,
  slug: photo.slug,
}));

// Sort by date (newest first) if dates exist, otherwise keep original order
photos.sort((a, b) => {
  if (a.date && b.date) return b.date.getTime() - a.date.getTime();
  if (a.date) return -1;
  if (b.date) return 1;
  return 0;
});

const categories = [...new Set(photos.map((p) => p.category))];
const isInProgress = entry.data["display-in-progress"] === true;
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  displayInProgress={isInProgress}
>
  <section class="max-w-6xl mx-auto px-4 md:px-6 py-12 md:py-24">
    <!-- Header -->
    <header class="mb-12 max-w-2xl animate-fade-up">
      <h1 class="font-display text-4xl md:text-5xl mb-4 gradient-text">
        {entry.data.title}
      </h1>
      <p class="text-base-content/70 text-lg leading-relaxed">
        {entry.data.description}
      </p>
    </header>

    <!-- Category Filters -->
    <div class="flex flex-wrap gap-2 mb-8 animate-fade-up stagger-1">
      <button
        class="filter-btn active px-4 py-2 rounded-full text-sm transition-all"
        data-category="all"
      >
        All
      </button>
      {
        categories.map((category) => (
          <button
            class="filter-btn px-4 py-2 rounded-full text-sm transition-all"
            data-category={category}
          >
            {category}
          </button>
        ))
      }
    </div>

    <!-- Photo Gallery -->
    <div class="photo-gallery animate-fade-up stagger-2">
      {
        photos.map((photo, index) => (
          <div
            class="photo-item frosted-card"
            data-category={photo.category}
            data-src={photo.src}
            data-alt={photo.alt}
            style={`animation-delay: ${index * 0.1}s`}
          >
            <img src={photo.thumb} alt={photo.alt} loading="lazy" decoding="async" />
            <div class="photo-overlay">
              <p class="font-medium text-lg">{photo.alt}</p>
              <p class="text-sm opacity-70 mt-1">
                {photo.location} Â· {photo.category}
              </p>
            </div>
          </div>
        ))
      }
    </div>

    <!-- Empty state when no photos -->
    {photos.length === 0 && (
      <div class="mt-16 p-6 rounded-2xl frosted-card animate-fade-up stagger-3">
        <p class="text-base-content/70 text-sm text-center">
          No photos yet. Add markdown files to <code>content/photos/</code> to populate the gallery.
        </p>
      </div>
    )}
  </section>

  <style>
    .filter-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--fallback-bc, #f8f4fc);
      opacity: 0.7;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: rgba(244, 114, 182, 0.15);
      border-color: rgba(244, 114, 182, 0.3);
      color: var(--color-accent-500, #ec4899);
      opacity: 1;
    }

    [data-theme="light"] .filter-btn {
      background: rgba(0, 0, 0, 0.03);
      border-color: rgba(0, 0, 0, 0.1);
      color: #1a1225;
    }

    [data-theme="light"] .filter-btn:hover,
    [data-theme="light"] .filter-btn.active {
      background: rgba(236, 72, 153, 0.1);
      border-color: rgba(236, 72, 153, 0.3);
      color: var(--color-accent-600, #db2777);
      opacity: 1;
    }

    .photo-item.hidden {
      display: none;
    }
  </style>

  <script>
    // Initialize photography gallery filters
    function initPhotographyFilters() {
      const filterBtns = document.querySelectorAll(".filter-btn");
      const photoItems = document.querySelectorAll(".photo-item");

      // Only add listeners if not already initialized
      filterBtns.forEach((btn) => {
        if ((btn as any).__filterInitialized) return;
        (btn as any).__filterInitialized = true;

        btn.addEventListener("click", () => {
          filterBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          const category = btn.getAttribute("data-category");

          photoItems.forEach((item) => {
            if (
              category === "all" ||
              item.getAttribute("data-category") === category
            ) {
              item.classList.remove("hidden");
            } else {
              item.classList.add("hidden");
            }
          });
        });
      });
    }

    // Run on initial load
    initPhotographyFilters();

    // Also run on view transitions
    document.addEventListener("astro:page-load", initPhotographyFilters);
  </script>
</BaseLayout>
