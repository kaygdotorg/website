---
/**
 * =============================================================================
 * PHOTOGRAPHY GALLERY PAGE (/photography)
 * =============================================================================
 *
 * Displays photos from the 'photography' content collection in a filterable gallery.
 *
 * ARCHITECTURE:
 * - Page metadata comes from photography/index.md
 * - Photos come from photography/*.md (each photo is a markdown file with metadata)
 * - Categories are extracted from photo metadata for filtering
 *
 * FEATURES:
 * - Category filter buttons
 * - Responsive photo grid
 * - Photo overlay with title and location
 * - Empty state when no photos exist
 * - Supports "in-progress" display mode
 *
 * PHOTO METADATA (in frontmatter):
 * - src: Full-resolution image path/URL
 * - thumb: Thumbnail image (optional, falls back to src)
 * - alt: Alt text for accessibility
 * - title: Photo title (optional)
 * - category: Category for filtering
 * - location: Where the photo was taken (optional)
 * - date: When the photo was taken (optional)
 * - camera: Camera/equipment used (optional)
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// =============================================================================
// DATA FETCHING
// =============================================================================

/**
 * Get all entries from the photography collection.
 * This includes both the index.md (page metadata) and photo entries.
 */
const allEntries = await getCollection("photography");

/**
 * Get page metadata from photography/index.md.
 * This provides the page title, description, and display settings.
 */
const entry = allEntries.find((e) => e.id === "index");

if (!entry) {
  throw new Error(
    "Missing photography/index.md - This file provides the page title and description."
  );
}

/**
 * Get photo entries (everything except index.md).
 * Photos are identified by having a 'src' field in frontmatter.
 */
const photoEntries = allEntries.filter(
  (e) => e.id !== "index" && e.data.src
);

// =============================================================================
// DATA TRANSFORMATION
// =============================================================================

/**
 * Transform photo entries into display format.
 * Normalizes the data structure for consistent template rendering.
 */
const photos = photoEntries.map((photo) => ({
  src: photo.data.src,
  thumb: photo.data.thumb || photo.data.src, // Fallback to full-res if no thumb
  alt: photo.data.alt,
  title: photo.data.title || photo.data.alt,
  category: photo.data.category,
  location: photo.data.location,
  date: photo.data.date,
  camera: photo.data.camera,
  id: photo.id, // Use entry.id instead of slug (Astro 5 compatibility)
}));

/**
 * Sort photos by date (newest first).
 * Photos without dates are sorted to the end.
 */
photos.sort((a, b) => {
  if (a.date && b.date) return b.date.getTime() - a.date.getTime();
  if (a.date) return -1;
  if (b.date) return 1;
  return 0;
});

/**
 * Extract unique categories for filter buttons.
 */
const categories = [...new Set(photos.map((p) => p.category))];

/**
 * Check if page should display "in progress" indicator.
 */
const isInProgress = entry.data["display-in-progress"] === true;
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  displayInProgress={isInProgress}
>
  <section class="max-w-6xl mx-auto px-4 md:px-6 py-12 md:py-24">
    {/* =========================================================================
        PAGE HEADER
        ========================================================================= */}
    <header class="mb-12 max-w-2xl animate-fade-up">
      <h1 class="font-display text-4xl md:text-5xl mb-4 gradient-text">
        {entry.data.title}
      </h1>
      <p class="text-base-content/70 text-lg leading-relaxed">
        {entry.data.description}
      </p>
    </header>

    {/* =========================================================================
        CATEGORY FILTER
        Buttons for filtering photos by category. "All" shows everything.
        ========================================================================= */}
    <div class="flex flex-wrap gap-2 mb-8 animate-fade-up stagger-1">
      <button
        class="filter-btn active px-4 py-2 rounded-full text-sm transition-all"
        data-category="all"
      >
        All
      </button>
      {categories.map((category) => (
        <button
          class="filter-btn px-4 py-2 rounded-full text-sm transition-all"
          data-category={category}
        >
          {category}
        </button>
      ))}
    </div>

    {/* =========================================================================
        PHOTO GALLERY
        Grid of photos with overlay information on hover.
        ========================================================================= */}
    <div class="photo-gallery animate-fade-up stagger-2">
      {photos.map((photo, index) => (
        <div
          class="photo-item frosted-card"
          data-category={photo.category}
          data-src={photo.src}
          data-alt={photo.alt}
          style={`animation-delay: ${index * 0.1}s`}
        >
          <img
            src={photo.thumb}
            alt={photo.alt}
            loading="lazy"
            decoding="async"
          />
          <div class="photo-overlay">
            <p class="font-medium text-lg">{photo.alt}</p>
            <p class="text-sm opacity-70 mt-1">
              {photo.location} Â· {photo.category}
            </p>
          </div>
        </div>
      ))}
    </div>

    {/* =========================================================================
        EMPTY STATE
        Shown when no photos exist in the collection.
        ========================================================================= */}
    {photos.length === 0 && (
      <div class="mt-16 p-6 rounded-2xl frosted-card animate-fade-up stagger-3">
        <p class="text-base-content/70 text-sm text-center">
          No photos yet. Add markdown files to <code>content/photography/</code> to
          populate the gallery.
        </p>
      </div>
    )}
  </section>

  {/* ===========================================================================
      STYLES
      Filter button styling with dark/light mode support.
      =========================================================================== */}
  <style>
    /* Filter button base styles */
    .filter-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--fallback-bc, #f8f4fc);
      opacity: 0.7;
    }

    /* Filter button hover and active states */
    .filter-btn:hover,
    .filter-btn.active {
      background: rgba(244, 114, 182, 0.15);
      border-color: rgba(244, 114, 182, 0.3);
      color: var(--color-accent-500, #ec4899);
      opacity: 1;
    }

    /* Light mode overrides */
    [data-theme="light"] .filter-btn {
      background: rgba(0, 0, 0, 0.03);
      border-color: rgba(0, 0, 0, 0.1);
      color: #1a1225;
    }

    [data-theme="light"] .filter-btn:hover,
    [data-theme="light"] .filter-btn.active {
      background: rgba(236, 72, 153, 0.1);
      border-color: rgba(236, 72, 153, 0.3);
      color: var(--color-accent-600, #db2777);
      opacity: 1;
    }

    /* Hidden class for filtered-out photos */
    .photo-item.hidden {
      display: none;
    }
  </style>

  {/* ===========================================================================
      FILTER SCRIPT
      Handles category filter button interactions.
      =========================================================================== */}
  <script>
    /**
     * Initialize photography gallery filter functionality.
     * Uses event delegation and tracks initialization state to prevent
     * duplicate listeners on view transitions.
     */
    function initPhotographyFilters() {
      const filterBtns = document.querySelectorAll(".filter-btn");
      const photoItems = document.querySelectorAll(".photo-item");

      filterBtns.forEach((btn) => {
        // Skip if already initialized (prevents duplicate listeners)
        if ((btn as any).__filterInitialized) return;
        (btn as any).__filterInitialized = true;

        btn.addEventListener("click", () => {
          // Update active state on buttons
          filterBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // Get selected category
          const category = btn.getAttribute("data-category");

          // Show/hide photos based on category
          photoItems.forEach((item) => {
            const matches =
              category === "all" ||
              item.getAttribute("data-category") === category;

            if (matches) {
              item.classList.remove("hidden");
            } else {
              item.classList.add("hidden");
            }
          });
        });
      });
    }

    // Initialize on first load
    initPhotographyFilters();

    // Re-initialize after view transitions (Astro's page navigation)
    document.addEventListener("astro:page-load", initPhotographyFilters);
  </script>
</BaseLayout>
