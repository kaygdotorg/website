---
import "../styles/global.css";
import Icon from "../components/Icon.astro";

interface Props {
  title: string;
  description?: string;
  hideNavInitially?: boolean;
}

const {
  title,
  description = "Personal website",
  hideNavInitially = false,
} = Astro.props;
const currentPath = Astro.url.pathname;

const visibleNavLinks = [
  { href: "/about", label: "About" },
  { href: "/contact", label: "Contact" },
  { href: "/blog", label: "Writing" },
  { href: "/now", label: "Now" },
  { href: "/uses", label: "Uses" },
];

const allNavLinks = [
  { href: "/", label: "Home" },
  ...visibleNavLinks,
  { href: "/photography", label: "Photography" },
  { href: "/notes", label: "Notes" },
  { href: "/talks", label: "Talks" },
];

import { ClientRouter } from "astro:transitions";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta
      name="theme-color"
      content="#faf8fc"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#0d0910"
      media="(prefers-color-scheme: dark)"
    />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ClientRouter />
    <!-- Fonts are now self-hosted via fontsource -->
    <!-- Theme detection: respects system preference, allows override -->
    <script is:inline>
      (function () {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          document.documentElement.setAttribute("data-theme", savedTheme);
        } else {
          // No saved preference: use system preference
          const prefersDark = window.matchMedia(
            "(prefers-color-scheme: dark)",
          ).matches;
          document.documentElement.setAttribute(
            "data-theme",
            prefersDark ? "dark" : "light",
          );
        }

        // Set initial theme color for both meta tags
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const themeColorLight = document.querySelector(
          'meta[name="theme-color"][media*="light"]',
        );
        const themeColorDark = document.querySelector(
          'meta[name="theme-color"][media*="dark"]',
        );
        const bgColor = currentTheme === "dark" ? "#0d0910" : "#faf8fc";
        if (themeColorLight) themeColorLight.setAttribute("content", bgColor);
        if (themeColorDark) themeColorDark.setAttribute("content", bgColor);
      })();
    </script>
  </head>
  <body class="min-h-screen text-base-content">
    <!-- Animated Film Grain Background -->
    <div class="animated-gradient-bg" aria-hidden="true" transition:persist>
      <!-- Soft color flares (like light leaks) -->
      <div class="film-flare"></div>
      <!-- Subtle color tint -->
      <div class="film-tint"></div>
      <!-- Vignette darkening at edges -->
      <div class="film-vignette"></div>
    </div>

    <!-- Global Image Zoom Overlay -->
    <div id="zoom-overlay" class="zoom-overlay" aria-hidden="true">
      <img id="zoomed-image" class="zoomed-image" src="" alt="" />
    </div>

    <!-- Floating Pill Navigation -->
    <nav
      id="nav-container"
      class:list={[
        "fixed top-0 left-0 right-0 z-50 p-4 nav-container",
        hideNavInitially ? "nav-hidden" : "nav-visible",
      ]}
    >
      <div class="max-w-4xl mx-auto">
        <!-- Desktop: Three separate pills -->
        <div class="hidden md:flex items-center justify-center gap-3">
          <!-- Left pill: Logo -->
          <a href="/" class="glass-pill nav-logo px-3 py-2 transition-all">
            <span class="nav-logo-text"
              >@kayg<span class="nav-logo-expand">dotorg</span></span
            >
          </a>

          <!-- Center pill: Nav links -->
          <div class="glass-pill px-2 py-1">
            <ul class="nav-link-container flex items-center gap-1 text-sm">
              {
                visibleNavLinks.map((link) => (
                  <li>
                    <a
                      href={link.href}
                      class:list={[
                        "nav-link block px-3 py-1.5 rounded-full transition-all",
                        currentPath === link.href
                          ? "bg-base-content/10 text-accent"
                          : "text-base-content/70 hover:text-base-content hover:bg-base-content/5",
                      ]}
                    >
                      {link.label}
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>

          <!-- Right pill: Search + Theme toggle + Menu toggle -->
          <div class="glass-pill flex items-center gap-1 p-1">
            <button
              id="search-toggle-desktop"
              class="search-pill flex items-center hover:bg-base-content/10 transition-all rounded-full p-2 group"
              aria-label="Search"
            >
              <Icon
                name="search"
                class="w-5 h-5 text-base-content/70 group-hover:text-base-content"
              />
              <span
                class="search-expand-label text-sm font-medium text-base-content/70"
              >
                Search <span id="search-shortcut-label" class="opacity-50 ml-1"
                  >CMD + K</span
                >
              </span>
            </button>
            <button
              id="theme-toggle-desktop"
              class="p-2 rounded-full hover:bg-base-content/10 transition-colors cursor-pointer flex items-center"
              aria-label="Toggle dark mode"
            >
              <Icon name="sun" id="sun-icon-desktop" class="sun-icon w-5 h-5" />
              <Icon
                name="moon"
                id="moon-icon-desktop"
                class="moon-icon w-5 h-5"
              />
              <span
                class="theme-expand-label text-sm font-medium text-base-content/70"
              >
                Theme <span id="theme-shortcut-label" class="opacity-50 ml-1"
                  >CMD + D</span
                >
              </span>
            </button>
            <button
              id="menu-toggle-desktop"
              class="p-2 rounded-full hover:bg-base-content/10 transition-colors cursor-pointer flex items-center"
              aria-label="Open menu"
            >
              <Icon
                name="hamburger"
                id="hamburger-icon-desktop"
                class="w-5 h-5"
              />
              <Icon
                name="close"
                id="close-icon-desktop"
                class="w-5 h-5 hidden"
              />
              <span
                class="menu-expand-label text-sm font-medium text-base-content/70"
              >
                Menu <span id="menu-shortcut-label" class="opacity-50 ml-1"
                  >CMD + /</span
                >
              </span>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile: Logo left, controls right -->
      <div class="flex md:hidden items-center justify-between">
        <!-- Left pill: Logo -->
        <a
          href="/"
          class="glass-pill nav-logo nav-logo-mobile px-3 py-2 transition-all"
        >
          <span class="nav-logo-text">@kaygdotorg</span>
        </a>

        <!-- Right pill: Search + Theme toggle + Hamburger -->
        <div class="glass-pill flex items-center gap-1 p-1">
          <button
            id="search-toggle-mobile"
            class="p-2 rounded-full hover:bg-base-content/10 transition-colors cursor-pointer"
            aria-label="Search"
          >
            <Icon name="search" class="w-5 h-5" strokeWidth={2} />
          </button>
          <button
            id="theme-toggle-mobile"
            class="p-2 rounded-full hover:bg-base-content/10 transition-colors cursor-pointer"
            aria-label="Toggle dark mode"
          >
            <Icon name="sun" class="sun-icon w-5 h-5" strokeWidth={2} />
            <Icon name="moon" class="moon-icon w-5 h-5" strokeWidth={2} />
          </button>
          <button
            id="mobile-menu-toggle"
            class="p-2 rounded-full hover:bg-base-content/10 transition-colors cursor-pointer"
            aria-label="Open menu"
          >
            <Icon
              name="hamburger"
              id="hamburger-icon"
              class="w-5 h-5"
              strokeWidth={2}
            />
            <Icon
              name="close"
              id="close-icon"
              class="w-5 h-5 hidden"
              strokeWidth={2}
            />
          </button>
        </div>
      </div>
    </nav>

    <!-- Progressive Blur Overlay (variable blur below navbar) -->
    <div
      id="navbar-blur"
      class:list={["navbar-blur-overlay", hideNavInitially && "blur-hidden"]}
      aria-hidden="true"
    >
    </div>

    <!-- Mobile Menu Overlay (centered) -->
    <div id="mobile-menu" class="mobile-menu-container fixed inset-0 z-40">
      <!-- Backdrop - dims and blurs the page -->
      <div
        id="mobile-menu-backdrop"
        class="mobile-menu-backdrop absolute inset-0"
      >
      </div>

      <!-- Centered menu panel with grainy card -->
      <div
        id="mobile-menu-inner"
        class="absolute inset-0 flex items-center justify-center p-6"
      >
        <div class="mobile-menu-card frosted-card w-full max-w-sm p-6">
          <ul class="flex flex-col gap-2">
            {
              allNavLinks.map((link) => (
                <li>
                  <a
                    href={link.href}
                    class:list={[
                      "block px-4 py-3 rounded-2xl text-lg text-center transition-all",
                      currentPath === link.href
                        ? "bg-base-content/10 text-accent font-medium"
                        : "text-base-content/80 hover:text-base-content hover:bg-base-content/5",
                    ]}
                  >
                    {link.label}
                  </a>
                </li>
              ))
            }
            <li class="mt-4 flex justify-center">
              <button
                id="menu-search-toggle"
                class="p-4 rounded-2xl text-base-content/60 hover:text-base-content hover:bg-base-content/10 transition-all cursor-pointer group"
                aria-label="Search"
              >
                <Icon
                  name="search"
                  class="w-6 h-6 group-hover:scale-110 transition-transform"
                  strokeWidth={2}
                />
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="search-modal-container fixed inset-0 z-[60]">
      <div id="search-backdrop" class="search-backdrop absolute inset-0"></div>
      <div
        id="search-modal-inner"
        class="absolute inset-0 flex items-start justify-center pt-20 md:pt-32 p-4"
      >
        <div class="search-modal-card frosted-card w-full max-w-2xl">
          <div id="search-container"></div>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <main class={`relative z-10 ${hideNavInitially ? "" : "pt-24"}`}>
      <slot />
    </main>

    <style>
      /* When using page cards, remove footer margin */
      main:has(.page-cards-container) + footer {
        display: none;
      }

      /* Hide navbar when mobile menu or search is active */
      :global(body.mobile-menu-active) .nav-container,
      :global(body.search-active) .nav-container {
        opacity: 0 !important;
        pointer-events: none !important;
        transform: translateY(-20px) !important;
        transition:
          opacity 0.3s ease,
          transform 0.3s ease !important;
      }

      .nav-container {
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
    </style>

    <!-- Footer -->
    <footer class="relative z-10 border-t border-base-content/10 mt-24">
      <div class="max-w-4xl mx-auto px-6 py-12">
        <div
          class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6"
        >
          <p class="text-sm text-base-content/60">
            &copy; {new Date().getFullYear()} · Built with curiosity
          </p>
          <div class="flex items-center gap-4">
            <a
              href="https://github.com"
              target="_blank"
              rel="noopener"
              class="text-base-content/60 hover:text-base-content transition-colors"
            >
              <Icon name="github" class="w-5 h-5" />
            </a>
            <a
              href="https://twitter.com"
              target="_blank"
              rel="noopener"
              class="text-base-content/60 hover:text-base-content transition-colors"
            >
              <Icon name="twitter" class="w-5 h-5" />
            </a>
            <a
              href="mailto:hello@example.com"
              class="text-base-content/60 hover:text-base-content transition-colors"
            >
              <Icon name="email" class="w-5 h-5" />
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Scroll Progress Button (outside stacking contexts, hidden on homepage) -->
    <button
      id="scroll-progress-btn"
      class:list={[
        "scroll-progress-btn",
        currentPath === "/" ? "hidden-permanently" : "hidden",
      ]}
      aria-label="Scroll to top or bottom"
    >
      <svg class="scroll-progress-ring" viewBox="0 0 36 36">
        <circle
          class="scroll-progress-bg"
          cx="18"
          cy="18"
          r="16"
          fill="none"
          stroke-width="2"></circle>
        <circle
          class="scroll-progress-fill"
          cx="18"
          cy="18"
          r="16"
          fill="none"
          stroke-width="2"></circle>
      </svg>
      <Icon
        name="arrow-down"
        class="scroll-progress-icon scroll-down"
        strokeWidth={2}
      />
      <Icon
        name="arrow-up"
        class="scroll-progress-icon scroll-up hidden"
        strokeWidth={2}
      />
    </button>

    <!-- Scripts -->
    <script>
      // =========================================================================
      // THEME TOGGLE UTILITY
      // =========================================================================
      //
      // Shared function used by both click handlers and keyboard shortcuts.
      // Consolidates all theme switching logic in one place.
      //
      // WHAT IT DOES:
      // 1. Toggles data-theme attribute between 'dark' and 'light'
      // 2. Persists preference to localStorage
      // 3. Updates theme-color meta tags (for Safari address bar color)
      // 4. Adds/removes theme-transitioning class for smooth CSS transitions
      //
      // CALLED BY:
      // - Click handler on theme toggle buttons (desktop + mobile)
      // - Keyboard shortcut: CMD/CTRL + D
      //
      // =========================================================================
      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";

        // Add transitioning class for CSS animations
        html.classList.add("theme-transitioning");

        // Update theme attribute and persist to localStorage
        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);

        // Update theme-color meta tags for Safari address bar
        // Both light and dark media queries get the same color since
        // we're overriding the preferred color scheme with user choice
        const bgColor = newTheme === "dark" ? "#0d0910" : "#faf8fc";
        const themeColorLight = document.querySelector(
          'meta[name="theme-color"][media*="light"]',
        );
        const themeColorDark = document.querySelector(
          'meta[name="theme-color"][media*="dark"]',
        );
        if (themeColorLight) themeColorLight.setAttribute("content", bgColor);
        if (themeColorDark) themeColorDark.setAttribute("content", bgColor);

        // Remove transitioning class after animation completes (300ms)
        setTimeout(() => {
          html.classList.remove("theme-transitioning");
        }, 300);
      }

      // Initialize theme toggle on every page load (needed for View Transitions)
      function initThemeToggle() {
        const themeToggles = [
          document.getElementById("theme-toggle-desktop"),
          document.getElementById("theme-toggle-mobile"),
        ];

        themeToggles.forEach((toggle) => {
          if (!toggle) return;
          // Remove old listeners by cloning the element
          const newToggle = toggle.cloneNode(true);
          if (newToggle && toggle.parentNode) {
            toggle.parentNode.replaceChild(newToggle, toggle);
            newToggle.addEventListener("click", toggleTheme);
          }
        });
      }

      // Initialize on first load
      initThemeToggle();

      // Re-initialize after View Transitions navigation
      document.addEventListener("astro:page-load", () => {
        // Restore theme from localStorage after navigation (View Transitions may reset it)
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          document.documentElement.setAttribute("data-theme", savedTheme);
        } else {
          const prefersDark = window.matchMedia(
            "(prefers-color-scheme: dark)",
          ).matches;
          document.documentElement.setAttribute(
            "data-theme",
            prefersDark ? "dark" : "light",
          );
        }

        // Restore theme-color
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const themeColorMeta = document.querySelector(
          'meta[name="theme-color"]',
        );
        if (themeColorMeta) {
          themeColorMeta.setAttribute(
            "content",
            currentTheme === "dark" ? "#0d0910" : "#faf8fc",
          );
        }

        initThemeToggle();
      });

      // Pause animations when tab is hidden (performance)
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          document.body.classList.add("reduce-motion");
        } else {
          document.body.classList.remove("reduce-motion");
        }
      });

      // Global menu toggle (mobile/desktop) - wrapped for View Transitions
      function initGlobalMenu() {
        const mobileMenu = document.getElementById("mobile-menu");
        const mobileMenuBackdrop = document.getElementById(
          "mobile-menu-backdrop",
        );
        const mobileMenuInner = document.getElementById("mobile-menu-inner");
        const hamburgerIcons = [
          document.getElementById("hamburger-icon"),
          document.getElementById("hamburger-icon-desktop"),
        ];
        const closeIcons = [
          document.getElementById("close-icon"),
          document.getElementById("close-icon-desktop"),
        ];

        function openMenu() {
          mobileMenu?.classList.add("menu-open");
          document.body.classList.add("mobile-menu-active");
          hamburgerIcons.forEach((icon) => icon?.classList.add("hidden"));
          closeIcons.forEach((icon) => icon?.classList.remove("hidden"));
          document.body.style.overflow = "hidden";
        }

        function closeMenu() {
          mobileMenu?.classList.remove("menu-open");
          // Remove body class after all menu animations finish (0.4s total)
          setTimeout(() => {
            document.body.classList.remove("mobile-menu-active");
          }, 400);
          hamburgerIcons.forEach((icon) => icon?.classList.remove("hidden"));
          closeIcons.forEach((icon) => icon?.classList.add("hidden"));
          document.body.style.overflow = "";
        }

        if (mobileMenuInner) {
          mobileMenuInner.addEventListener("click", (e) => {
            if (e.target === mobileMenuInner) closeMenu();
          });
        }

        const toggles = [
          document.getElementById("mobile-menu-toggle"),
          document.getElementById("menu-toggle-desktop"),
        ];

        toggles.forEach((toggle) => {
          if (!toggle) return;
          const newToggle = toggle.cloneNode(true) as HTMLElement;
          toggle.parentNode?.replaceChild(newToggle, toggle);
          newToggle.addEventListener("click", () => {
            const isOpen = mobileMenu?.classList.contains("menu-open");
            if (isOpen) closeMenu();
            else openMenu();
          });
        });

        if (mobileMenuBackdrop) {
          const newBackdrop = mobileMenuBackdrop.cloneNode(true) as HTMLElement;
          mobileMenuBackdrop.parentNode?.replaceChild(
            newBackdrop,
            mobileMenuBackdrop,
          );
          newBackdrop.addEventListener("click", closeMenu);
        }

        mobileMenu?.querySelectorAll("a").forEach((link) => {
          link.addEventListener("click", closeMenu);
        });

        const menuSearchToggle = document.getElementById("menu-search-toggle");
        if (menuSearchToggle) {
          const newSearchToggle = menuSearchToggle.cloneNode(
            true,
          ) as HTMLElement;
          menuSearchToggle.parentNode?.replaceChild(
            newSearchToggle,
            menuSearchToggle,
          );
          newSearchToggle.addEventListener("click", () => {
            closeMenu();
            setTimeout(() => {
              const searchToggle =
                document.getElementById("search-toggle-desktop") ||
                document.getElementById("search-toggle-mobile");
              searchToggle?.click();
            }, 100);
          });
        }
      }

      // Search Modal - wrapped for View Transitions
      function initSearchModal() {
        const searchModal = document.getElementById("search-modal");
        const searchBackdrop = document.getElementById("search-backdrop");
        const searchContainer = document.getElementById("search-container");
        const searchToggles = [
          document.getElementById("search-toggle-desktop"),
          document.getElementById("search-toggle-mobile"),
        ];

        let pagefindLoaded = false;

        async function loadPagefind() {
          if (pagefindLoaded) return;
          try {
            if (
              !document.querySelector('link[href="/pagefind/pagefind-ui.css"]')
            ) {
              const link = document.createElement("link");
              link.rel = "stylesheet";
              link.href = "/pagefind/pagefind-ui.css";
              document.head.appendChild(link);
            }
            await new Promise<void>((resolve, reject) => {
              if ((window as any).PagefindUI) {
                resolve();
                return;
              }
              const script = document.createElement("script");
              script.src = "/pagefind/pagefind-ui.js";
              script.onload = () => resolve();
              script.onerror = reject;
              document.head.appendChild(script);
            });
            new (window as any).PagefindUI({
              element: "#search-container",
              showSubResults: true,
              showImages: false,
              excerptLength: 15,
            });
            pagefindLoaded = true;
          } catch (e) {
            console.error("Pagefind load error:", e);
            if (searchContainer) {
              searchContainer.innerHTML = `
                <div class="p-6 text-center text-base-content/60">
                  <p class="mb-2">Search is available after building the index.</p>
                  <p class="text-sm">Run <code class="bg-base-content/10 px-2 py-1 rounded">npm run build:search</code> to enable search in dev mode.</p>
                </div>
              `;
            }
          }
        }

        const searchModalInner = document.getElementById("search-modal-inner");
        if (searchModalInner) {
          searchModalInner.addEventListener("click", (e) => {
            if (e.target === searchModalInner) closeSearch();
          });
        }

        function openSearch() {
          searchModal?.classList.add("search-open");
          document.body.classList.add("search-active");
          document.body.style.overflow = "hidden";
          loadPagefind().then(() => {
            setTimeout(() => {
              const input = searchContainer?.querySelector("input");
              (input as HTMLInputElement)?.focus();
            }, 100);
          });
        }

        function closeSearch() {
          searchModal?.classList.remove("search-open");
          // Remove body class after animations (0.4s)
          setTimeout(() => {
            document.body.classList.remove("search-active");
          }, 400);
          document.body.style.overflow = "";
        }

        searchToggles.forEach((toggle) => {
          if (toggle) {
            const newToggle = toggle.cloneNode(true) as HTMLElement;
            toggle.parentNode?.replaceChild(newToggle, toggle);
            newToggle.addEventListener("click", () => {
              const isOpen = searchModal?.classList.contains("search-open");
              if (isOpen) closeSearch();
              else openSearch();
            });
          }
        });

        if (searchBackdrop) {
          const newBackdrop = searchBackdrop.cloneNode(true) as HTMLElement;
          searchBackdrop.parentNode?.replaceChild(newBackdrop, searchBackdrop);
          newBackdrop.addEventListener("click", closeSearch);
        }
      }

      // Initialize all interactive elements
      initGlobalMenu();
      initSearchModal();

      // Re-initialize after View Transitions navigation
      document.addEventListener("astro:page-load", () => {
        initGlobalMenu();
        initSearchModal();
        updateSearchShortcut();
        updateThemeShortcut();
        updateMenuShortcut();
      });

      // Update Search Shortcut based on OS
      function updateSearchShortcut() {
        const label = document.getElementById("search-shortcut-label");
        if (label) {
          const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
          label.textContent = isMac ? "CMD + K" : "CTRL + K";
        }
      }
      updateSearchShortcut();

      // Update Theme Shortcut based on OS
      function updateThemeShortcut() {
        const label = document.getElementById("theme-shortcut-label");
        if (label) {
          const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
          label.textContent = isMac ? "CMD + D" : "CTRL + D";
        }
      }
      updateThemeShortcut();

      // Update Menu Shortcut based on OS
      function updateMenuShortcut() {
        const label = document.getElementById("menu-shortcut-label");
        if (label) {
          const isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
          label.textContent = isMac ? "CMD + /" : "CTRL + /";
        }
      }
      updateMenuShortcut();

      // Global keyboard shortcuts (only add once)
      if (!(window as any).__keyboardShortcutsInitialized) {
        document.addEventListener("keydown", (e) => {
          const searchModal = document.getElementById("search-modal");
          const mobileMenu = document.getElementById("mobile-menu");

          if (e.key === "Escape") {
            if (searchModal?.classList.contains("search-open")) {
              searchModal.classList.remove("search-open");
              document.body.style.overflow = "";
            } else if (mobileMenu?.classList.contains("menu-open")) {
              mobileMenu.classList.remove("menu-open");
              document.body.classList.remove("mobile-menu-active");
              document.body.style.overflow = "";
            }
          }
          // CMD/CTRL + K: Toggle search
          if ((e.metaKey || e.ctrlKey) && e.key === "k") {
            e.preventDefault();
            if (searchModal?.classList.contains("search-open")) {
              searchModal.classList.remove("search-open");
              setTimeout(() => {
                document.body.classList.remove("search-active");
              }, 400);
              document.body.style.overflow = "";
            } else {
              searchModal?.classList.add("search-open");
              document.body.classList.add("search-active");
              document.body.style.overflow = "hidden";
              // Focus input
              setTimeout(() => {
                const input = searchModal?.querySelector("input");
                (input as HTMLInputElement)?.focus();
              }, 100);
            }
          }
          // CMD/CTRL + D: Toggle dark/light mode
          // Uses shared toggleTheme() function for consistent behavior
          if ((e.metaKey || e.ctrlKey) && e.key === "d") {
            e.preventDefault();
            toggleTheme();
          }
          // CMD/CTRL + /: Toggle menu
          if ((e.metaKey || e.ctrlKey) && e.key === "/") {
            e.preventDefault();
            const menuToggle =
              document.getElementById("menu-toggle-desktop") ||
              document.getElementById("mobile-menu-toggle");
            menuToggle?.click();
          }
        });
        (window as any).__keyboardShortcutsInitialized = true;
      }

      /**
       * =========================================================================
       * IMAGE ZOOM (LIGHTBOX) FEATURE
       * =========================================================================
       *
       * Provides click-to-zoom functionality for images in content areas.
       * When an image is clicked, it displays in a full-screen overlay that
       * can be dismissed by clicking anywhere or pressing Escape.
       *
       * SUPPORTED IMAGE SELECTORS:
       * - .prose img        → Images in markdown/prose content
       * - .md-card-body img → Images in markdown card components
       * - .photo-item img   → Images in photo galleries
       *
       * -------------------------------------------------------------------------
       * VIEW TRANSITIONS COMPATIBILITY
       * -------------------------------------------------------------------------
       *
       * PROBLEM: This function is called on initial page load AND on every
       * astro:page-load event (View Transitions navigation). Without guards,
       * each call adds ADDITIONAL event listeners, causing:
       *
       * - Multiple escape key handlers → multiple close attempts
       * - Multiple overlay click handlers → memory leaks
       * - Multiple image click handlers → multiple zoom opens
       *
       * SOLUTION: Three different patterns for three different cases:
       *
       * 1. INDIVIDUAL IMAGES: Use __zoomInitialized flag on each element
       *    - Check if img.__zoomInitialized exists before adding listener
       *    - Set the flag after adding listener
       *    - Works because images are DOM elements that persist or are new
       *
       * 2. OVERLAY CLICK: Clone the overlay element
       *    - Cloning an element removes all attached event listeners
       *    - Replace original with clone, then add fresh listener
       *    - Safe because overlay is a single element we control
       *
       * 3. ESCAPE KEY: Use global window flag __imageZoomEscapeInitialized
       *    - Document keydown listener is global (survives navigation)
       *    - Only add once, persists throughout session
       *    - Use dynamic overlay lookup in handler (handles cloning)
       *
       * =========================================================================
       */
      function initImageZoom() {
        // ---------------------------------------------------------------------
        // FIND ALL ZOOMABLE IMAGES
        // ---------------------------------------------------------------------
        const images = document.querySelectorAll(
          ".prose img, .md-card-body img, .photo-item img",
        );

        // Exit early if no overlay exists (safety check)
        const overlayCheck = document.getElementById("zoom-overlay");
        if (!overlayCheck) return;

        // ---------------------------------------------------------------------
        // ATTACH CLICK HANDLERS TO IMAGES
        // ---------------------------------------------------------------------
        // Each image tracks its own initialization state via __zoomInitialized.
        // This prevents duplicate handlers when images persist across navigations.
        //
        // IMPORTANT: Handlers use DYNAMIC lookup (getElementById) instead of
        // closures. This ensures we always get the current overlay element,
        // which is essential for View Transitions compatibility.
        //
        images.forEach((img) => {
          // Skip if already initialized OR has no src attribute
          if ((img as any).__zoomInitialized || !img.getAttribute("src"))
            return;

          // Mark as initialized to prevent duplicate handlers
          (img as any).__zoomInitialized = true;

          img.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();

            // DYNAMIC LOOKUP: Get current overlay and image elements
            // This handles View Transitions where DOM may have changed
            const overlay = document.getElementById("zoom-overlay");
            const zoomedImg = document.getElementById(
              "zoomed-image",
            ) as HTMLImageElement;

            if (!overlay || !zoomedImg) return;

            const src = img.getAttribute("src");
            const alt = img.getAttribute("alt");
            if (src) {
              zoomedImg.src = src;
              zoomedImg.alt = alt || "";
              overlay.classList.add("active");
              document.body.style.overflow = "hidden"; // Prevent background scroll
            }
          });
        });

        // ---------------------------------------------------------------------
        // OVERLAY CLICK TO CLOSE - Uses Global Flag Pattern
        // ---------------------------------------------------------------------
        //
        // PATTERN: Single global listener with initialization guard
        //
        // WHY: Overlay click listener must be added only ONCE to prevent
        // duplicates across View Transitions navigations. We use a window
        // flag to track whether it's already been added.
        //
        // The handler uses dynamic lookup (getElementById) to get the current
        // overlay, ensuring it works correctly after any DOM changes.
        //
        if (!(window as any).__imageZoomOverlayInitialized) {
          overlayCheck.addEventListener("click", () => {
            // DYNAMIC LOOKUP: Get current overlay
            const overlay = document.getElementById("zoom-overlay");
            if (overlay) {
              overlay.classList.remove("active");
              document.body.style.overflow = ""; // Re-enable background scroll
            }
          });
          (window as any).__imageZoomOverlayInitialized = true;
        }

        // ---------------------------------------------------------------------
        // ESCAPE KEY TO CLOSE - Uses Global Flag Pattern
        // ---------------------------------------------------------------------
        //
        // PATTERN: Single global listener with initialization guard
        //
        // WHY: Document-level keydown listeners persist across View Transitions.
        // Adding a new one each navigation would create duplicates. Instead:
        // - Check window.__imageZoomEscapeInitialized flag
        // - If not set, add the listener and set the flag
        // - If set, skip (listener already exists from previous load)
        //
        // The handler uses dynamic lookup to always get the current overlay.
        //
        if (!(window as any).__imageZoomEscapeInitialized) {
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
              // DYNAMIC LOOKUP: Get current overlay
              const overlay = document.getElementById("zoom-overlay");
              if (overlay?.classList.contains("active")) {
                overlay.classList.remove("active");
                document.body.style.overflow = "";
              }
            }
          });
          (window as any).__imageZoomEscapeInitialized = true;
        }
      }

      // Run on initial page load
      initImageZoom();

      // Re-initialize after View Transitions navigation
      // This ensures newly loaded images get zoom functionality
      document.addEventListener("astro:page-load", () => {
        initImageZoom();
      });
    </script>
  </body>
</html>
